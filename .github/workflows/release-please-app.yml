name: release-please-app

on:
  workflow_call:
    inputs:
      GITHUB_APP_ID:
        description: 'The ID of the GitHub App to authenticate as when using release-please'
        required: true
        type: string
      MONOREPO_TAGS_ENABLED:
        description: 'Whether to enable monorepo tags'
        required: false
        default: true
        type: boolean
      AUTO_MERGE:
        description: 'Auto-merge release PRs. If AUTO_MERGE_TAGS is set, only when all release tags match the pattern.'
        required: false
        default: false
        type: boolean
      AUTO_MERGE_TAGS:
        description: 'Regex pattern to match release tags (e.g. "(api|web)-v.*"). If empty, all releases are auto-merged.'
        required: false
        default: ''
        type: string
    secrets:
      GITHUB_APP_PRIVATE_KEY:
        description: 'The private key of the GitHub App to authenticate as when using release-please'
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{steps.release.outputs.releases_created}}
      paths_released: ${{steps.release.outputs.paths_released}}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ inputs.GITHUB_APP_ID }}
          private-key: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          include-component-in-tag: ${{ inputs.MONOREPO_TAGS_ENABLED }}
          token: ${{ steps.app-token.outputs.token }}

  # Runs after prepare to auto-merge the release PR if one exists.
  # When no release PR is pending (e.g. prepare just created releases), this no-ops.
  automerge:
    needs: prepare
    if: inputs.AUTO_MERGE
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ inputs.GITHUB_APP_ID }}
          private-key: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}

      - name: Find release PR
        id: find-pr
        run: |
          PR_NUMBER=$(gh pr list --repo "${{ github.repository }}" \
            --label "autorelease: pending" \
            --head "release-please--branches--main" \
            --json number --jq '.[0].number')
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check release tags
        id: check-tags
        if: steps.find-pr.outputs.pr_number != ''
        run: |
          # No tag filter → auto-merge all releases
          if [ -z "$AUTO_MERGE_TAGS" ]; then
            echo "should_merge=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          REPO="${{ github.repository }}"

          # Fetch release-please config to map paths → component names
          CONFIG=$(gh api "repos/$REPO/contents/release-please-config.json" -q '.content' | base64 -d) || {
            echo "::error::Failed to fetch release-please-config.json"
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
            exit 0
          }

          # Get the manifest diff to see which packages are being released
          MANIFEST_PATCH=$(gh api "repos/$REPO/pulls/$PR_NUMBER/files" \
            --jq '.[] | select(.filename == ".release-please-manifest.json") | .patch')

          if [ -z "$MANIFEST_PATCH" ]; then
            echo "::notice::No manifest changes found — skipping auto-merge"
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Build tag names from the manifest diff (added lines = new versions)
          TAGS=$(echo "$MANIFEST_PATCH" | grep '^+' | grep -v '^+++' | while IFS= read -r line; do
            PATH_KEY=$(echo "$line" | sed -nE 's/.*"([^"]+)"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/p')
            VERSION=$(echo "$line" | sed -nE 's/.*"([^"]+)"[[:space:]]*:[[:space:]]*"([^"]+)".*/\2/p')
            [ -z "$PATH_KEY" ] && continue
            COMPONENT=$(echo "$CONFIG" | jq -r --arg p "$PATH_KEY" '.packages[$p].component // empty')

            # Root package (".") without explicit component → tag is just vVERSION
            if [ -z "$COMPONENT" ] && [ "$PATH_KEY" = "." ]; then
              echo "v${VERSION}"
            else
              [ -z "$COMPONENT" ] && COMPONENT=$(basename "$PATH_KEY")
              echo "${COMPONENT}-v${VERSION}"
            fi
          done)

          if [ -z "$TAGS" ]; then
            echo "::notice::No release tags found — skipping auto-merge"
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Release tags in this PR:"
          echo "$TAGS"

          # Check ALL tags match the pattern
          SHOULD_MERGE=true
          while IFS= read -r tag; do
            if ! echo "$tag" | grep -qP "^${AUTO_MERGE_TAGS}$"; then
              echo "::notice::Tag '$tag' does not match pattern '${AUTO_MERGE_TAGS}' — skipping auto-merge"
              SHOULD_MERGE=false
              break
            fi
          done <<< "$TAGS"

          echo "should_merge=$SHOULD_MERGE" >> "$GITHUB_OUTPUT"
        env:
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
          AUTO_MERGE_TAGS: ${{ inputs.AUTO_MERGE_TAGS }}
          GH_TOKEN: ${{ github.token }}

      # Approve first so the review requirement is satisfied before auto-merge triggers.
      # Uses GITHUB_TOKEN (different identity than the App that merges).
      - name: Approve release PR
        if: steps.find-pr.outputs.pr_number != '' && steps.check-tags.outputs.should_merge == 'true'
        run: gh pr review --approve "$PR_NUMBER" -R "${{ github.repository }}"
        env:
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
          GH_TOKEN: ${{ github.token }}

      # Use the GitHub App token for merge so the push triggers workflows.
      # (GITHUB_TOKEN merges don't trigger workflows, breaking release creation)
      - name: Enable auto-merge
        if: steps.find-pr.outputs.pr_number != '' && steps.check-tags.outputs.should_merge == 'true'
        run: gh pr merge --auto --squash "$PR_NUMBER" -R "${{ github.repository }}"
        env:
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
